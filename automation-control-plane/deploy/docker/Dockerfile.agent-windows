# Build stage - use Linux to cross-compile for Windows
FROM --platform=linux/amd64 golang:1.21 AS builder

WORKDIR /build

# Copy probe module first (since agent depends on it)
COPY probe ./probe

# Copy agent go.mod and fix the replace directive
COPY automation-agent/go.mod ./go.mod.orig
RUN cat go.mod.orig | sed 's|replace github.com/yogzblr/probe => ../probe|replace github.com/yogzblr/probe => ./probe|' > go.mod && rm go.mod.orig

# Copy go.sum if it exists
COPY automation-agent/go.sum* ./

# Download dependencies
RUN go mod download

# Copy all source code
COPY automation-agent .

# Fix the go.mod again after copying source
RUN sed -i 's|replace github.com/yogzblr/probe => ../probe|replace github.com/yogzblr/probe => ./probe|' go.mod

# Run go mod tidy to update dependencies
RUN go mod tidy

# Cross-compile for Windows
RUN CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -o automation-agent.exe ./cmd/agent

# Runtime stage - Windows Nano Server
FROM mcr.microsoft.com/windows/nanoserver:ltsc2022

# Copy agent binary from builder
COPY --from=builder /build/automation-agent.exe C:\\automation-agent\\automation-agent.exe

# Set environment variables
ENV CONTROL_PLANE_URL=http://control-plane:8080
ENV TENANT_ID=test-tenant
ENV PROJECT_ID=test-project
ENV AGENT_ID=agent-windows-01
ENV LOG_LEVEL=info

WORKDIR C:\\automation-agent

# Run the agent directly
ENTRYPOINT ["C:\\automation-agent\\automation-agent.exe"]
